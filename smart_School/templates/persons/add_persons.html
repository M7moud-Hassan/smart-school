{% extends 'base_page.html' %}
{% load static %}
{% block mystyles %}
<link rel="stylesheet" href="{% static 'css/dropify.min.css' %}">
<link rel="stylesheet" href="{% static 'dist/libs/flatpickr/flatpickr.min.css' %}">
<link rel="stylesheet" href="{% static '/libs/prismjs/themes/prism-coy.min.css' %}">
{% endblock %}
{% block content %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb breadcrumb-example1 pt-2">
    <li class="breadcrumb-item"><a href="/">الرئسية</a></li>
    <li class="breadcrumb-item active" aria-current="page">اضافة شخص</li>
  </ol>
</nav>

<div class="card custom-card">
  <div class="card-header justify-content-between">
    <div class="card-title">
      اضافة شخص
    </div>
    <div class="prism-toggle">
      <!-- <button class="btn btn-sm btn-primary-light">Show Code<i
          class="ri-code-line ms-2 d-inline-block align-middle"></i></button> -->
    </div>
  </div>
  <div class="card-body">
    <form class="row g-3 needs-validation" method="post" action="{% url 'add_person' %}" enctype="multipart/form-data" novalidate>
      {% csrf_token %}
      <div class="row">
        <div class="col-12 col-md-4">
          <div class="form-group">
            {{form.front_national_img.label_tag}}
            {{form.front_national_img}}
          </div>
          <div class="btn-group my-1 w-100">
            <button type="button" class="btn btn-primary" id="uploadButton">get Data</button>
            <button type="button"
                class="btn btn-primary dropdown-toggle dropdown-toggle-split me-2"
                data-bs-toggle="dropdown" aria-expanded="false">
                <span class="visually-hidden">Toggle Dropdown</span>
            </button>
            <ul class="dropdown-menu">
              {% for camera in cameras %}
              <a class="dropdown-item" href="#" data-toggle="modal" onclick="openCamera(2,'{{camera.id}}')"
                data-target="#modal-info_2">{{camera.name}}</a>
              {% endfor %}
            </ul>
            <div class="modal fade" id="modal-info_2">
              <div class="modal-dialog">
                <div class="modal-content bg-info">
                  <div class="modal-header">
                    <h4 class="modal-title">Capture Image</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <img id="video-2" width="100%" height="300" />
                  </div>
                  <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-outline-light" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-outline-light" id="captureImage-2"
                      data-dismiss="modal">Capture</button>
                  </div>
                </div>
                
              </div>
              </div>
        </div>
          
        </div>
        <div class="col-12 col-md-4">
          <div class="form-group">
            {{form.back_national_img.label_tag}}
            {{form.back_national_img}}
          </div>
          <div class="btn-group my-1 w-100">
            <button type="button" class="btn btn-primary" id="uploadButton2">get Data</button>
            <button type="button"
                class="btn btn-primary dropdown-toggle dropdown-toggle-split me-2"
                data-bs-toggle="dropdown" aria-expanded="false">
                <span class="visually-hidden">Toggle Dropdown</span>
            </button>
            <ul class="dropdown-menu">
              {% for camera in cameras %}
              <a class="dropdown-item" href="#" data-toggle="modal" onclick="openCamera(2,'{{camera.id}}')"
                data-target="#modal-info_2">{{camera.name}}</a>
              {% endfor %}
            </ul>
            <div class="modal fade" id="modal-info_2">
              <div class="modal-dialog">
                <div class="modal-content bg-info">
                  <div class="modal-header">
                    <h4 class="modal-title">Capture Image</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <img id="video-2" width="100%" height="300" />
                  </div>
                  <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-outline-light" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-outline-light" id="captureImage-2"
                      data-dismiss="modal">Capture</button>
                  </div>
                </div>
                
              </div>
              </div>
        </div>
        </div>
        <div class="col-12 col-md-4">
          <div class="form-group">
            {{form.image.label_tag}}
            {{form.image}}
          </div>
          <div class="btn-group my-1 w-100">
            <button type="button" class="btn btn-primary">Action</button>
            <button type="button"
                class="btn btn-primary dropdown-toggle dropdown-toggle-split me-2"
                data-bs-toggle="dropdown" aria-expanded="false">
                <span class="visually-hidden">Toggle Dropdown</span>
            </button>
            <ul class="dropdown-menu">
              {% for camera in cameras %}
              <a class="dropdown-item" href="#" data-toggle="modal" onclick="openCamera(2,'{{camera.id}}')"
                data-target="#modal-info_2">{{camera.name}}</a>
              {% endfor %}
            </ul>
            <div class="modal fade" id="modal-info_2">
              <div class="modal-dialog">
                <div class="modal-content bg-info">
                  <div class="modal-header">
                    <h4 class="modal-title">Capture Image</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <img id="video-2" width="100%" height="300" />
                  </div>
                  <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-outline-light" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-outline-light" id="captureImage-2"
                      data-dismiss="modal">Capture</button>
                  </div>
                </div>
                
              </div>
              </div>
        </div>
        </div>
        </div>
        <div class="row mt-3 g-3">
        <div class="form-group col-12 col-md-6">
          {{ form.name.label_tag }}
          {{ form.name }}
        </div>
        <div class="form-group col-12 col-md-6">
          {{ form.id_national.label_tag }}
          {{ form.id_national }}
        </div>
        <div class="form-group col-12 col-md-6">
          {{ form.job_title.label_tag }}
          {{ form.job_title }}
        </div>
        <div class="col-12 col-md-6 row align-items-center mt-4 ps-4 pt-2">
          {% for radio in form.gender %}
          <div class="form-check form-check-md col-6">
            <input id="input{{radio.choice_label}}" type="radio" class="form-check-input" name="{{ form.gender.name }}" value="{{ radio.choice_label }}">
            <label for="input{{radio.choice_label}}" class="form-check-label">{{radio.choice_label}}</label>
        </div>
        {% endfor %}
    </div>
    <div class="form-group col-12 col-md-6">
      <label>Date:</label>
      <div class="input-group date" id="reservationdate" data-target-input="nearest">
        {{form.date_of_birth}}
        <div class="input-group-text text-muted"> <i class="ri-calendar-line"></i> </div>
      </div>
    </div>
    <div class="form-group col-12 col-md-6">
      {{ form.address.label_tag }}
      {{ form.address }}
    </div>
    <div class="form-group col-12 col-md-6">
      {{form.status.label_tag}}
      {{form.status}}
    </div>
    <div class="col-12 col-md-6 row align-items-center mt-4 ps-4 pt-2">
      {% for radio in form.type_register %}
      <div class="form-check form-check-md col-6">
        <input onchange="showOrhid('{{radio.choice_label}}')" id="input{{radio.choice_label}}" type="radio" class="form-check-input" name="{{ form.type_register.name }}" value="{{ radio.choice_label }}">
        <label for="input{{radio.choice_label}}" class="form-check-label">{{radio.choice_label}}</label>
    </div>
    {% endfor %}
</div>
      </div>
      <div id="employee">

      </div>
     
      </div>
        <button type="submit" class="btn btn-primary w-25 m-3">{{update_or_add}}</button>
    </form>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{% static 'js/dropify.min.js' %}"></script>
<script src="{% static 'dist/js/validation.js' %}"></script>
<script src="{% static 'dist/libs/flatpickr/flatpickr.min.js' %}"></script>
    <script src="{% static 'dist/js/date&time_pickers.js' %}"></script>
    <script src="{% static 'dist/libs/prismjs/prism.js' %}"></script>
    <script src="{% static 'dist/js/prism-custom.js' %}"></script>

<script>
  $(".dropify-face").dropify(
    {
      messages: {
        'default': 'حمل صورتك هنا ',
        'replace': 'اضغط لستبدال الصورة',
        'remove': 'مسح',
        'error': 'خطا في تحميل الصورة'
      }
    }
  );
  $(".dropify-back").dropify(
    {
      messages: {
        'default': 'حمل  صورة البطاقة الخلفية ',
        'replace': 'اضغط لستبدال الصورة',
        'remove': 'مسح',
        'error': 'خطا في تحميل الصورة'
      }
    }
  );

  $(".dropify-front").dropify(
    {
      messages: {
        'default': 'حمل  صورة البطاقة الامامية ',
        'replace': 'اضغط لستبدال الصورة',
        'remove': 'مسح',
        'error': 'خط في تحميل الصورة'
      }
    }
  );

  function openCamera(index, id) {
    $("#video-" + index).attr("src", "/cameras/video/" + id);
  }

  $('#captureImage').click(function () {

    $.ajax({
      url: '/cameras/capture_image/',
      type: 'GET',
      xhrFields: {
        responseType: 'blob' // Set the response type to 'blob'
      },
      success: function (response) {
        $('.dropify-clear').eq(2).click();
        const fileInput = document.getElementById('id_image');
        var filename = 'captured_image.jpg';
        // Create a new file object from the blob response
        var file = new File([response], filename, { type: 'image/jpeg' });
        // Add the file to the DataTransfer object
        dataTransfer = new DataTransfer()
        dataTransfer.items.add(file);
        fileInput.files = dataTransfer.files;
        addFileToDropify(2, file);
        $("#video-1").attr("src", "");
      },
      error: function (error) {
        console.log(error);
      }
    });
  });

  $('#captureImage-2').click(function () {

    $.ajax({
      url: '/cameras/capture_image/',
      type: 'GET',
      xhrFields: {
        responseType: 'blob'
      },
      success: function (response) {
        $('.dropify-clear').eq(0).click();
        const fileInput = document.getElementById('id_front_national_img');
        var filename = 'captured_image.jpg';

        var file = new File([response], filename, { type: 'image/jpeg' });
        // Add the file to the DataTransfer object
        dataTransfer = new DataTransfer()
        dataTransfer.items.add(file);
        fileInput.files = dataTransfer.files;
        addFileToDropify(0, file)
        $("#video-2").attr("src", "");
      },
      error: function (error) {
        console.log(error);
      }
    });
  });

  $('#captureImage-3').click(function () {

    $.ajax({
      url: '/cameras/capture_image/',
      type: 'GET',
      xhrFields: {
        responseType: 'blob'
      },
      success: function (response) {
        $('.dropify-clear').eq(1).click();
        const fileInput = document.getElementById('id_back_national_img');
        var filename = 'captured_image.jpg';

        var file = new File([response], filename, { type: 'image/jpeg' });
        // Add the file to the DataTransfer object
        dataTransfer = new DataTransfer()
        dataTransfer.items.add(file);
        fileInput.files = dataTransfer.files;
        addFileToDropify(1, file)
        $("#video-3").attr("src", "");
      },
      error: function (error) {
        console.log(error);
      }
    });
  });


  $(function () {

    $('#quickForm').validate({
      rules: {


        // image: {
        //   required: '{{update_or_add}}' != "update"
        // },
      },
      messages: {

      },
      errorElement: 'span',
      errorPlacement: function (error, element) {
        error.addClass('invalid-feedback');
        element.closest('.form-group').append(error);
      },
      highlight: function (element, errorClass, validClass) {
        $(element).addClass('is-invalid');
      },
      unhighlight: function (element, errorClass, validClass) {
        $(element).removeClass('is-invalid');
      }
    });
  });

  function onModalClosed() {
    $.ajax({
      url: '/cameras/release',
    });
    //$("#video").attr("src","");
  }
  $(document).on('hidden.bs.modal', '.modal', onModalClosed);

  $("#uploadButton").click(function () {
    $('#page-loader').addClass('show')
    var formData = new FormData();
    formData.append("image", $("#id_front_national_img")[0].files[0]);
    var csrfToken = $('[name=csrfmiddlewaretoken]').val(); // Extract CSRF token
    formData.append("csrfmiddlewaretoken", csrfToken);
    $.ajax({
      url: "/persons/get_details_from_national_img/",
      type: "POST",
      data: formData,
      processData: false,
      contentType: false,
      success: async function (response) {

        data = JSON.parse(response['response']);

        const originalDate = data.Birthday;

        // Split the date into day, month, and year
        const dateComponents = originalDate.split('-');
        const day = dateComponents[0];
        const month = dateComponents[1];
        const year = dateComponents[2];

        // Create the new date in "mm/dd/yyyy" format
        const newDateFormat = `${month}/${day}/${year}`;
        $('#id_name').val(`${data.firstname} ${data.secondname}`)
        $('#id_id_national').val(`${data.id}`)
        $('#id_date_of_birth').val(newDateFormat)
        $('#id_address').val(`${data.address_1} - ${data.address_2}`)
        const fileInput = document.getElementById('id_image');
        var filename = 'captured_image.jpg';
        // Create a new file object from the blob response
        const blob = new Blob([Uint8Array.from(atob(response['image']), c => c.charCodeAt(0))], { type: 'image/jpeg' });
        var file = new File([blob], filename, { type: 'image/jpeg' });
        // Add the file to the DataTransfer object
        dataTransfer = new DataTransfer()
        dataTransfer.items.add(file);
        fileInput.files = dataTransfer.files;
        addFileToDropify(2, file);
        $('#page-loader').removeClass('show')

      },
      error: function () {
        $('#page-loader').removeClass('show')
        alert("Error connecting to the server.");
      }
    });
  });
  $("#uploadButton2").click(function () {
    console.log($('#page-loader'));
    $('#page-loader').addClass('show');

    var formData = new FormData();
    formData.append("image", $("#id_back_national_img")[0].files[0]);
    var csrfToken = $('[name=csrfmiddlewaretoken]').val(); // Extract CSRF token
    formData.append("csrfmiddlewaretoken", csrfToken);
    $.ajax({
      url: "/persons/get_details_from_back_national_img/",
      type: "POST",
      data: formData,
      processData: false,
      contentType: false,
      success: async function (response) {
        data = JSON.parse(response['response']);
        console.log(data);
        $('#id_job_title').val(`${data.job} ${data.job_location}`)
        if (data.Gender == 'ذكر') {
          $('#labelMale').addClass('active')
          $('#inputMale').prop('checked', true);
          $('#labelFemale').removeClass('active')
          $('#inputFemal').prop('checked', false);
        } else {
          $('#labelFemale').addClass('active')
          $('#inputFemal').prop('checked', true);
          $('#labelMale').removeClass('active')
          $('#inputMale').prop('checked', false);
        }
        $('#page-loader').removeClass('show')
      },
      error: function () {
        alert("Error connecting to the server.");
        $('#page-loader').removeClass('show')
      }
    });
  });

  function addFileToDropify(index, file) {
    console.log(index)
    var reader = new FileReader();

    reader.onload = function (e) {
      $('.dropify-preview').eq(index).css('display', 'block');
      var imageElement = $('<img>');
      imageElement.attr('src', e.target.result);
      $('.dropify-clear').eq(index).css('display', 'block');
      $('.dropify-render').eq(index).append(imageElement);
    };

    // Convert the File object to a data URL
    reader.readAsDataURL(file);

  }
  function showOrhid(value) {
    // console.log(value);
    if (value == 'Employee') {
      $('#info-employee').remove()
    } else {
      $('#employee').append(`
      <div id="info-employee" class="col-12 pt-4">
      <h3>information visitor</h3>
        <div class="row g-3">
          <div class="form-group col-12 col-md-6">
            {{info_form.department.label_tag}}
            {{info_form.department}}
          </div>
          <div class="form-group col-12 col-md-6">
            {{info_form.type.label_tag}}
            {{info_form.type}}
          </div>
          <div class="form-group col-12 col-md-6">
            {{info_form.reason.label_tag}}
            {{info_form.reason}}
          </div>
          <div class="form-group col-12 col-md-6">
            {{info_form.other.label_tag}}
            {{info_form.other}}
          </div>
          <div class="form-group col-12 col-md-6">
            {{info_form.visior_type.label_tag}}
            {{info_form.visior_type}}
          </div>
        </div>
        </div>`)
    }
  }
</script>
{% endblock %}